\chapter{Návrh řešení}

Vzhledem k obecnosti termínu CSP existuje velké množství aplikací řešících problémy s omezujícími podmínkami - najdeme nespočet řešičů sudoku i řešičů známého SAT problému\footnote{Boolean satisfiability problem}. Vzniklo také několik obecných řešičů, například \emph{Geocode}\footnote{http://www.gecode.org} a \emph{Microsoft Solver Foundation}\footnote{https://msdn.microsoft.com/en-us/library/ff524509(v=vs.93).aspx}.

Řešení NCSP problémů pomocí propagace intervalů je již poměrně specifická oblast a tak těchto řešičů není mnoho. Na službě GitHub patří mezi nejznámější řešiče projekt \emph{JaCoP}\footnote{https://github.com/radsz/jacop}, dále existují například \emph{IASolver}\footnote{http://www.cs.brandeis.edu/~tim/Applets/IAsolver.html}, \emph{RSolver}\footnote{http://rsolver.sourceforge.net/} a \emph{RealPaver}\footnote{https://github.com/lcgutierrez/Realpaver-0\_4-Windows}. První dva projekty jsou napsány v Javě, třetí v jazyce OCaml a čtvrtý v C. Žádný z nich ale není dále vyvíjen.

Heuristiky používané při řešení problémů s omezujícími podmínkami jsou stále předmětem výzkumu, pro řešení NCSP se dají rozdělit do dvou skupin \cite{feiten10}:

\begin{itemize}
  \item Heuristiky rozhodující podle statických (neměnných) vlastností proměnných, například počtu jejich výskytů, nebo aritmetických operací, kterých se účastní.
  \item Heuristiky rozhodující podle domén proměnných - zúžit širokou doménu může být výhodnější než dále zužovat malou doménu.
\end{itemize}

\section{Možnosti řešení}
Většina řešičů omezujících podmínek propagací intervalů je založena na snaze dostat omezující podmínky do stavu \emph{hull consistency}, nebo \emph{box consistency} \cite{Benhamou99revisinghull}.

Omezující podmínka je hull konzistentní, pokud se podařilo nalézt nejmenší box, který obaluje všechna řešení splňující danou podmínku. Jsou známy dva základní algoritmy k dosažení hull consistency - \emph{HC3} a \emph{HC4}. Algoritmus HC3 byl navržen jako první z algoritmů pro propagaci intervalů v roce 1997 v článku \cite{Benhamou97applyinginterval}, autoři ho tehdy nazvali jednoduše jako \uv{A narrowing algorithm}. Název HC3 byl vytvořen později v článku \cite{Benhamou99revisinghull}, kde byl uveden i pokročilejší algoritmus HC4.

Tyto algoritmy jsou vhodné především v případě, kdy se jedna proměnná nevyskytuje ve více podmínkách najednou. Pokud tomu tak je, nastává tzv. \emph{dependency problem} (problém závislosti) a HC algoritmy se stávají neefektivními, neboť nalezený obal intervalů může být větší, než je ve skutečnosti potřeba \cite{BenhamouCLPIntervals}.

Pro potřeby HC algoritmů se proto omezující podmínky rozkládají do konjunkcí podmínek v jednoduchém tvaru (\emph{primitive constraints}, viz \cite{kue12}) pomocí zavedení pomocných proměnných. Rozdíl mezi ekvivalentními jednoduchými a komplexními podmínkami ukazují příklady č. \ref{eq:complexConstraint} a \ref{eq:primitiveConstraint}. Zjednodušeně řečeno se v jednoduché podmínce může vyskytovat maximálně jedna aritmetická operace.

\begin{equation} \label{eq:complexConstraint}
x + 2y + z = 1
\end{equation}

\begin{equation} \label{eq:primitiveConstraint}
v_1 = 2y \quad \wedge \quad v_2 = z - 1 \quad \wedge \quad v_3 = x + v_1 \quad \wedge \quad v_3 + v_2 = 0
\end{equation}

Oproti tomu jsou BC algoritmy složitější na implementaci než hull consistency algoritmy, efektivně ale řeší situaci, kdy se proměnná objevuje v několika omezujících podmínkách.

Tyto techniky se dají dále kombinovat například s \emph{branch and prune} algoritmy, které umožňují rekurzivně rozpůlit nalezený box a tyto poloviční boxy dále zmenšovat pomocí HC či BC algoritmů. Je tak možné získat několik menších boxů, které budou zahrnovat méně nadbytečných hodnot.

\subsection{Existující heuristiky}
V této sekci je pro přehled uvedeno několik příkladů existujících heuristik, ve výsledné bakalářské práci ale možná nebudou zkoumány pouze následující heuristiky, ale i některé jiné. Uvedené heuristiky jsou převzaty z \cite{feiten10}:

\begin{itemize}
  \item Heuristika \emph{dominant-first} se snaží nejprve redukovat domény \uv{dominantních proměnných} - tím jsou myšleny proměnné vyskytující se v původních nerozložených podmínkách,
  \item \emph{small-interval-first/last} se snaží dále zúžit nejužší, resp. nejširší intervaly,
  \item \emph{shrunk-interval-first/last} vybírá nejprve proměnné, jejichž domény byly od běhu nejvíce, resp. nejméně, od začátku běhu algoritmu zmenšeny (vypočítává se kvocient z původní a aktuální velikosti domény),
  \item \emph{max-cand} vybírá proměnnou s nejvyšší levou či pravou mezí domény. Např. proměnná s doménou $(1;6)$ může být vybrána dříve než proměnná s doménou $(1;3)$, protože má vyšší pravou mez.
\end{itemize}


S vedoucím práce bylo dohodnuto, že řešič bude podporovat omezující podmínky s operacemi sčítání, odčítání a násobení. Podmínky budou zadávány v jednoduchém tvaru, případně bude práce rozšířena o podporu rozkladu komplexních podmínek (\emph{complex constraints}) do konjunkcí jednoduchých podmínek. 

Řešení vstupních problémů bude probíhat s využitím algoritmu HC3 zmíněném v předchozí kapitole s mírnou úpravou pro pestřejší možnosti využití heuristik. Zatímco originální algoritmus vždy vybere z množiny podmínek jednu náhodnou a zredukuje domény všech proměnných v ní obsažených, upravený algoritmus heuristicky vybere dvojici $(c, x)$, kde $c$ je omezující podmínka a $x$ je proměnná obsažená v $c$, a podle této podmínky zúží doménu proměnné $x$. Algoritmus~\ref{HC3Algorithm} uvádí pseudokód takto upraveného algoritmu HC3.

\begin{algorithm}
\caption{Algoritmus HC3}
\label{HC3Algorithm}
\begin{algorithmic}[1]
\Procedure{HC3}{$P$}
\State $Q \gets P$
\While{$Q \neq \emptyset$ }
\State Pomocí heuristiky vyber z $Q$ pár $p = (c, x)$.
\State $Q \gets Q \setminus \left\{ p \right\}$
\State $D_x' \gets$ Zredukuj doménu $D_x$ proměnné $x$ podle podmínky $c$.
\If{$D_x' = \emptyset $}
\State Konec - CSP je nekonzistentní.
\EndIf
\If{$D_x \neq D_x'$}
\State $D_x \gets D_x'$
\State Přidej zpět do $Q$ pár $p$ a všechny další páry z $P$, které obsahují proměnnou $x$.
\EndIf
\EndWhile
\EndProcedure
\end{algorithmic}
\end{algorithm}

Nad HC3 algoritmem bude postaven jednoduchý branch and prune algoritmus (viz Algoritmus \ref{BranchPrune}), který zároveň tvoří hlavní funkci programu. Při spuštění je mu předán množina dvojic omezujících podmínek a proměnných v nich obsažených. Domény proměnných dohromady tvoří box a tento box je následně algoritmem HC3 zmenšen. Nový je poté rozpůlen a obě poloviny opět vstupují do branch and prune algoritmu. V pseudokódu se rovněž vyskytuje konstanta $\epsilon$, která určuje mez, kdy je nalezený box dostatečně malý a již ho není potřeba dále zmenšovat.

\begin{algorithm}
\caption{Branch \& Prune}
\label{BranchPrune}
\begin{algorithmic}[1]
\Require Množina dvojic $(c, x)$, kde $c$ je omezující podmínka definovaná nad proměnnou $x$.
\Ensure Seznam nalezených boxů.
\Procedure{Solve}{$P$}
\If{Problém není dostatečně malý}
\State $P' \gets HC3(P)$
\State $(P_1, P_2) \gets $ rozděl box tvořený proměnnými z $P'$ na poloviny.
\State Solve($P_1$)
\State Solve($P_2$)
\Else
\State Vypiš/ulož box tvořený proměnnými z $P$ jako jeden z výsledků.
\EndIf
\EndProcedure
\end{algorithmic}
\end{algorithm}

V algoritmu \ref{BranchPrune} jsou dva řádky, které je nutné dále rozebrat - podmínku pro ukončení algoritmu (řádek č.~2) a~způsob rozdělení problému na~poloviny (řádek č.~4).

Pro ukončení algoritmu je potřeba stanovit mezní velikost, pod kterou se musí domény dominantních proměnných zúžit. Tato mez může být absolutní (velikost domény maximálně například 0,01), nebo relativní vzhledem k původním nezúženým doménám (například požadavek za zmenšení domény na tisícinu původní velikosti).

Na tomto programu budou otestovány vybrané heuristiky a výsledky měření porovnány.